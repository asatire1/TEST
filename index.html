<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Tournament Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #1F2937;
            margin-bottom: 5px;
        }

        .header p {
            color: #6B7280;
            font-size: 14px;
        }

        .tab-nav {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab-nav::-webkit-scrollbar {
            height: 6px;
        }

        .tab-nav::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }

        .tab-buttons {
            display: inline-flex;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: #F3F4F6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: #3B82F6;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-section select {
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3B82F6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563EB;
        }

        .btn-secondary {
            background: #6B7280;
            color: white;
        }

        .btn-danger {
            background: #DC2626;
            color: white;
        }

        .btn-success {
            background: #16A34A;
            color: white;
        }

        .round-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .round-btn {
            padding: 8px 16px;
            border: 2px solid #D1D5DB;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .round-btn:hover, .round-btn.active {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }

        .match-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 641px) {
            .match-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1025px) {
            .match-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .match-card {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
            background: white;
        }

        .match-card.within-group {
            border-color: #A855F7;
            background: #FAF5FF;
        }

        .match-card.cross-group {
            border-color: #10B981;
            background: #F0FDF4;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .match-type-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-within {
            background: #A855F7;
            color: white;
        }

        .badge-cross {
            background: #10B981;
            color: white;
        }

        .complete-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            background: #16A34A;
            color: white;
        }

        .team-section {
            margin: 12px 0;
        }

        .team-players {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .player-badge {
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }

        .tier-elite { background: #DC2626; }
        .tier-advanced { background: #EA580C; }
        .tier-intermediate-plus { background: #CA8A04; }
        .tier-intermediate { background: #16A34A; }
        .tier-beginner-plus { background: #2563EB; }
        .tier-beginner { background: #7C3AED; }

        .team-info {
            font-size: 12px;
            color: #6B7280;
            margin-bottom: 8px;
        }

        .score-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 12px 0;
        }

        .score-input input {
            width: 60px;
            padding: 8px;
            border: 2px solid #D1D5DB;
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }

        .score-divider {
            font-size: 20px;
            font-weight: 600;
            color: #6B7280;
        }

        .clear-score-btn {
            padding: 6px 12px;
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .winner-banner {
            background: #10B981;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-top: 12px;
        }

        .player-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 641px) {
            .player-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1025px) {
            .player-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .player-edit-card {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
        }

        .player-edit-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .player-edit-card input {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .player-edit-card input:focus {
            outline: none;
            border-color: #3B82F6;
        }

        .player-edit-card input.changed {
            border-color: #F59E0B;
            background: #FFFBEB;
        }

        .unsaved-indicator {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .unsaved-indicator.show {
            display: flex;
        }

        .unsaved-indicator span {
            color: #92400E;
            font-weight: 600;
        }

        .info-panel {
            background: #EFF6FF;
            border: 2px solid #DBEAFE;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #1E40AF;
            margin-bottom: 12px;
        }

        .info-panel ul {
            list-style-position: inside;
            color: #1E3A8A;
        }

        .data-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 641px) {
            .data-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .action-card {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .action-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .action-card p {
            color: #6B7280;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .standings-table th {
            background: #F3F4F6;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #D1D5DB;
        }

        .standings-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #E5E7EB;
        }

        .standings-table tr:hover {
            background: #F9FAFB;
        }

        .rank-medal {
            font-size: 18px;
        }

        .saved-versions {
            margin-top: 20px;
        }

        .version-item {
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .version-info {
            flex: 1;
        }

        .version-info h4 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .version-info p {
            font-size: 12px;
            color: #6B7280;
        }

        .version-actions {
            display: flex;
            gap: 8px;
        }

        .fairness-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            overflow-x: auto;
        }

        .fairness-table th, .fairness-table td {
            padding: 8px;
            border: 1px solid #E5E7EB;
            text-align: center;
        }

        .fairness-table th {
            background: #F3F4F6;
            font-weight: 600;
        }

        .fairness-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .fairness-positive {
            background: #FEE2E2;
            color: #991B1B;
        }

        .fairness-negative {
            background: #DCFCE7;
            color: #166534;
        }

        .fairness-neutral {
            background: #F3F4F6;
            color: #374151;
        }

        .partnership-matrix {
            overflow-x: auto;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .matrix-table td, .matrix-table th {
            width: 40px;
            height: 40px;
            text-align: center;
            border: 1px solid #E5E7EB;
        }

        .matrix-table th {
            background: #F3F4F6;
            font-weight: 600;
        }

        .matrix-cell-0 { background: #F9FAFB; }
        .matrix-cell-1 { background: #DBEAFE; }
        .matrix-cell-2 { background: #BFDBFE; }
        .matrix-cell-3 { background: #93C5FD; color: white; }

        .knockout-config {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .config-item {
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
        }

        .config-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .config-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
        }

        .qualified-players {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .qualified-badge {
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        .bracket-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 641px) {
            .bracket-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .bracket-match {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
            background: white;
        }

        .bracket-match h3 {
            text-align: center;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .bracket-match h4 {
            font-size: 12px;
            color: #6B7280;
            text-align: center;
            margin-bottom: 12px;
        }

        .final-match {
            border: 3px solid #F59E0B;
            background: #FFFBEB;
        }

        .champion-banner {
            background: linear-gradient(135deg, #F59E0B, #EAB308);
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            margin-top: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #F9FAFB;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #6B7280;
        }

        .hidden {
            display: none !important;
        }

        input[type="file"] {
            padding: 10px;
            border: 2px dashed #D1D5DB;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèì Padel Tournament</h1>
            <p>24 Players ‚Ä¢ 13 Rounds ‚Ä¢ Fairness-Optimized Competition</p>
        </div>

        <div class="tab-nav">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('fixtures')">üèÜ Tournament</button>
                <button class="tab-btn" onclick="switchTab('players')">üë• Players</button>
                <button class="tab-btn" onclick="switchTab('data')">üíæ Data</button>
                <button class="tab-btn" onclick="switchTab('results')">üìä Results</button>
                <button class="tab-btn" onclick="switchTab('fairness1')">‚öñÔ∏è Fairness</button>
                <button class="tab-btn" onclick="switchTab('fairness2')">‚öñÔ∏è Fairness 2</button>
                <button class="tab-btn" onclick="switchTab('partnerships')">ü§ù Partnerships</button>
                <button class="tab-btn" onclick="switchTab('knockout')">üèÜ Knockout</button>
            </div>
        </div>

        <div id="fixtures" class="tab-content active">
            <div class="content-card">
                <div class="filter-section">
                    <select id="roundFilter" onchange="applyFilters()">
                        <option value="all">All Rounds</option>
                    </select>
                    <select id="playerFilter" onchange="applyFilters()">
                        <option value="all">All Players</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>
                <div id="roundNavigation" class="round-nav"></div>
                <div id="matchesContainer" class="match-grid"></div>
            </div>
        </div>

        <div id="players" class="tab-content">
            <div class="content-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Edit Player Names</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="savePlayerChanges(event)">üíæ Save Changes</button>
                        <button class="btn btn-danger" onclick="resetAllNames()">Reset All Names</button>
                    </div>
                </div>
                <div id="unsavedIndicator" class="unsaved-indicator">
                    <span>‚ö†Ô∏è</span>
                    <span>You have unsaved changes. Click "Save Changes" to apply.</span>
                </div>
                <div id="playersContainer" class="player-grid"></div>
                <div class="info-panel">
                    <h3>Tips:</h3>
                    <ul>
                        <li>Players 1-4 are Elite level</li>
                        <li>Players 21-24 are Beginner level</li>
                        <li>Ratings range from 0 to 5</li>
                        <li><strong>Click "Save Changes" to apply updates to all pages</strong></li>
                        <li>Use Data Management to save backups</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="data" class="tab-content">
            <div class="content-card">
                <div class="data-actions">
                    <div class="action-card">
                        <h3>üíæ Export Tournament</h3>
                        <p>Download all data as JSON</p>
                        <button class="btn btn-primary" onclick="exportData()">Download Data File</button>
                    </div>
                    <div class="action-card">
                        <h3>üìÇ Import Tournament</h3>
                        <p>Upload previous backup</p>
                        <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                    </div>
                    <div class="action-card">
                        <h3>‚ö†Ô∏è Reset Match Scores</h3>
                        <p>Clear all scores, keep names. Auto-saves first</p>
                        <button class="btn btn-danger" onclick="resetScores()">Reset All Scores</button>
                    </div>
                    <div class="action-card">
                        <h3>üíæ Save Current Version</h3>
                        <p>Create named backup (session storage)</p>
                        <button class="btn btn-success" onclick="saveVersion()">Save Backup</button>
                    </div>
                </div>
                <div class="saved-versions" id="savedVersions"></div>
            </div>
        </div>

        <div id="results" class="tab-content">
            <div class="content-card">
                <div class="info-panel">
                    <h3>Tournament Point System</h3>
                    <p><strong>Win:</strong> 3 points | <strong>Draw:</strong> 1 point | <strong>Loss:</strong> 0 points</p>
                </div>
                <div style="overflow-x: auto; margin-top: 20px;">
                    <table class="standings-table" id="standingsTable"></table>
                </div>
            </div>
        </div>

        <div id="fairness1" class="tab-content">
            <div class="content-card">
                <div class="info-panel">
                    <h3>How Fairness is Calculated</h3>
                    <p><strong>Fairness = Your Team Rating - Opponent Rating</strong></p>
                    <ul>
                        <li><strong>Negative</strong> = Harder opponents (tougher match)</li>
                        <li><strong>Positive</strong> = Easier opponents (easier match)</li>
                        <li><strong>Zero</strong> = Perfectly balanced</li>
                    </ul>
                </div>
                <div style="overflow-x: auto; margin-top: 20px;">
                    <table class="fairness-table" id="fairness1Table"></table>
                </div>
            </div>
        </div>

        <div id="fairness2" class="tab-content">
            <div class="content-card">
                <div class="info-panel">
                    <h3>How Fairness 2 is Calculated</h3>
                    <p><strong>Fairness = Partner Rating - Avg Opponent Rating</strong></p>
                    <ul>
                        <li><strong>Negative</strong> = Weaker partner vs opponents</li>
                        <li><strong>Positive</strong> = Stronger partner vs opponents</li>
                        <li>Shows partner quality compensation</li>
                    </ul>
                </div>
                <div style="overflow-x: auto; margin-top: 20px;">
                    <table class="fairness-table" id="fairness2Table"></table>
                </div>
            </div>
        </div>

        <div id="partnerships" class="tab-content">
            <div class="content-card">
                <div class="stats-grid" id="partnershipStats"></div>
                <h3 style="margin: 20px 0;">Partnership Frequency Matrix</h3>
                <p style="color: #6B7280; margin-bottom: 10px; font-size: 14px;">Numbers = times paired together</p>
                <div class="partnership-matrix" id="partnershipMatrix"></div>
                <h3 style="margin: 30px 0 10px 0;">Opponent Frequency Matrix</h3>
                <p style="color: #6B7280; margin-bottom: 10px; font-size: 14px;">Numbers = times faced as opponents</p>
                <div class="partnership-matrix" id="opponentMatrix"></div>
            </div>
        </div>

        <div id="knockout" class="tab-content">
            <div class="content-card">
                <div class="knockout-config">
                    <div class="config-item">
                        <label>Quarter Finals Scoring</label>
                        <select id="qfPoints" onchange="saveKnockoutConfig()">
                            <option value="8">Best of 8</option>
                            <option value="12">Best of 12</option>
                            <option value="16" selected>Best of 16</option>
                            <option value="20">Best of 20</option>
                            <option value="24">Best of 24</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>Semi Finals Scoring</label>
                        <select id="sfPoints" onchange="saveKnockoutConfig()">
                            <option value="8">Best of 8</option>
                            <option value="12">Best of 12</option>
                            <option value="16" selected>Best of 16</option>
                            <option value="20">Best of 20</option>
                            <option value="24">Best of 24</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>üèÜ Final Match Scoring</label>
                        <select id="finalPoints" onchange="saveKnockoutConfig()">
                            <option value="8">Best of 8</option>
                            <option value="12">Best of 12</option>
                            <option value="16" selected>Best of 16</option>
                            <option value="20">Best of 20</option>
                            <option value="24">Best of 24</option>
                        </select>
                    </div>
                </div>
                <h3 style="margin-bottom: 10px;">Top 12 Qualified Players</h3>
                <div class="qualified-players" id="qualifiedPlayers"></div>
                <h3 style="margin: 30px 0 10px 0;">Quarter Finals</h3>
                <div class="bracket-grid" id="quarterFinals"></div>
                <h3 style="margin: 30px 0 10px 0;">Semi Finals</h3>
                <div class="bracket-grid" id="semiFinals"></div>
                <h3 style="margin: 30px 0 10px 0;">üèÜ Championship Final</h3>
                <div id="final"></div>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let matches = [];
        let knockoutMatches = {
            quarterFinals: [],
            semiFinals: [],
            final: null
        };
        let knockoutConfig = {
            qfPoints: 16,
            sfPoints: 16,
            finalPoints: 16
        };

        function initializePlayers() {
            const tierNames = ['Elite', 'Advanced', 'Intermediate+', 'Intermediate', 'Beginner+', 'Beginner'];
            const baseRatings = [3.85, 3.50, 3.15, 2.85, 2.65, 2.50];
            
            for (let i = 0; i < 24; i++) {
                const tier = Math.floor(i / 4);
                const tierOffset = (i % 4) * -0.05;
                players.push({
                    id: i + 1,
                    name: `Player ${i + 1}`,
                    tier: tierNames[tier],
                    rating: baseRatings[tier] + tierOffset,
                    group: tier + 1
                });
            }
        }

        function generateMatches() {
            matches = [];
            
            const fixture = [
                [[[1, 4], [2, 3]], [[5, 8], [6, 7]], [[9, 12], [10, 11]], [[13, 16], [14, 15]], [[17, 20], [18, 19]], [[21, 24], [22, 23]]],
                [[[1, 24], [10, 16]], [[2, 23], [6, 19]], [[3, 22], [7, 18]], [[4, 21], [8, 17]], [[5, 20], [13, 12]], [[11, 15], [14, 9]]],
                [[[1, 10], [9, 4]], [[2, 11], [12, 3]], [[5, 18], [13, 8]], [[6, 17], [14, 7]], [[15, 24], [19, 20]], [[16, 23], [22, 21]]],
                [[[1, 21], [17, 2]], [[4, 19], [18, 3]], [[5, 12], [9, 8]], [[6, 11], [10, 7]], [[13, 24], [20, 16]], [[14, 23], [22, 15]]],
                [[[4, 14], [13, 1]], [[2, 16], [15, 3]], [[6, 24], [21, 10]], [[5, 23], [11, 7]], [[8, 22], [17, 12]], [[9, 19], [18, 20]]],
                [[[1, 12], [5, 4]], [[2, 7], [6, 3]], [[9, 20], [21, 8]], [[10, 23], [22, 11]], [[13, 24], [17, 18]], [[14, 19], [16, 15]]],
                [[[2, 24], [5, 20]], [[4, 23], [6, 19]], [[1, 22], [7, 18]], [[3, 21], [8, 17]], [[15, 16], [13, 12]], [[9, 11], [14, 10]]],
                [[[5, 12], [9, 4]], [[1, 13], [8, 2]], [[6, 16], [11, 10]], [[3, 17], [14, 7]], [[21, 19], [23, 20]], [[22, 18], [15, 24]]],
                [[[2, 24], [17, 4]], [[1, 19], [18, 3]], [[6, 12], [11, 8]], [[5, 9], [10, 7]], [[14, 20], [21, 16]], [[13, 23], [22, 15]]],
                [[[2, 23], [15, 5]], [[1, 22], [4, 20]], [[8, 7], [9, 18]], [[12, 14], [19, 13]], [[3, 24], [10, 17]], [[11, 16], [6, 21]]],
                [[[12, 22], [16, 20]], [[1, 23], [6, 11]], [[2, 9], [7, 8]], [[3, 21], [5, 13]], [[10, 18], [14, 15]], [[24, 4], [19, 17]]],
                [[[2, 16], [13, 4]], [[5, 17], [14, 1]], [[6, 24], [21, 8]], [[3, 22], [15, 7]], [[10, 18], [23, 12]], [[9, 19], [20, 11]]],
                [[[2, 8], [5, 4]], [[3, 7], [6, 1]], [[10, 24], [21, 12]], [[9, 23], [15, 11]], [[14, 20], [17, 16]], [[13, 19], [18, 22]]]
            ];
            
            fixture.forEach((round, roundIndex) => {
                round.forEach(match => {
                    const team1Players = match[0].map(id => players.find(p => p.id === id));
                    const team2Players = match[1].map(id => players.find(p => p.id === id));
                    
                    const team1Groups = team1Players.map(p => p.group);
                    const team2Groups = team2Players.map(p => p.group);
                    const allGroups = [...team1Groups, ...team2Groups];
                    const uniqueGroups = [...new Set(allGroups)];
                    const isWithinGroup = uniqueGroups.length === 1;
                    
                    matches.push({
                        round: roundIndex + 1,
                        team1: team1Players,
                        team2: team2Players,
                        score1: null,
                        score2: null,
                        type: isWithinGroup ? 'within' : 'cross'
                    });
                });
            });
        }

        function getTierClass(player) {
            const tierClasses = {
                'Elite': 'tier-elite',
                'Advanced': 'tier-advanced',
                'Intermediate+': 'tier-intermediate-plus',
                'Intermediate': 'tier-intermediate',
                'Beginner+': 'tier-beginner-plus',
                'Beginner': 'tier-beginner'
            };
            return tierClasses[player.tier] || 'tier-beginner';
        }

        function renderPlayerBadge(player, showRating = false) {
            return `
                <div class="player-badge ${getTierClass(player)}">
                    ${player.name}
                    ${showRating ? `<div style="font-size: 11px;">${player.rating.toFixed(2)}</div>` : ''}
                </div>
            `;
        }

        function renderMatches() {
            const container = document.getElementById('matchesContainer');
            const roundFilter = document.getElementById('roundFilter').value;
            const playerFilter = document.getElementById('playerFilter').value;
            
            let filteredMatches = matches;
            
            if (roundFilter !== 'all') {
                filteredMatches = filteredMatches.filter(m => m.round === parseInt(roundFilter));
            }
            
            if (playerFilter !== 'all') {
                const playerId = parseInt(playerFilter);
                filteredMatches = filteredMatches.filter(m => 
                    m.team1.some(p => p.id === playerId) || m.team2.some(p => p.id === playerId)
                );
            }
            
            container.innerHTML = filteredMatches.map((match, index) => {
                const team1Rating = match.team1.reduce((sum, p) => sum + p.rating, 0);
                const team2Rating = match.team2.reduce((sum, p) => sum + p.rating, 0);
                const isComplete = match.score1 !== null && match.score2 !== null;
                const winner = isComplete ? (match.score1 > match.score2 ? 1 : (match.score2 > match.score1 ? 2 : 0)) : 0;
                
                return `
                    <div class="match-card ${match.type === 'within' ? 'within-group' : 'cross-group'}">
                        <div class="match-header">
                            <strong>Match ${matches.indexOf(match) + 1} (R${match.round})</strong>
                            <div>
                                <span class="match-type-badge ${match.type === 'within' ? 'badge-within' : 'badge-cross'}">
                                    ${match.type === 'within' ? 'Within Group' : 'Cross Group'}
                                </span>
                                ${isComplete ? '<span class="complete-badge">Complete ‚úì</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="team-section">
                            <div class="team-players">
                                ${renderPlayerBadge(match.team1[0])}
                                ${renderPlayerBadge(match.team1[1])}
                            </div>
                            <div class="team-info">
                                Groups: ${match.team1.map(p => p.group).join(', ')} | Total Rating: ${team1Rating.toFixed(2)}
                            </div>
                        </div>
                        
                        <div class="score-input">
                            <input type="number" min="0" max="16" value="${match.score1 !== null ? match.score1 : ''}" 
                                   onchange="updateScore(${matches.indexOf(match)}, 1, this.value)"
                                   placeholder="__">
                            <span class="score-divider">-</span>
                            <input type="number" min="0" max="16" value="${match.score2 !== null ? match.score2 : ''}"
                                   onchange="updateScore(${matches.indexOf(match)}, 2, this.value)"
                                   placeholder="__">
                            ${isComplete ? `<button class="clear-score-btn" onclick="clearScore(${matches.indexOf(match)})">Clear √ó</button>` : ''}
                        </div>
                        
                        <div class="team-section">
                            <div class="team-players">
                                ${renderPlayerBadge(match.team2[0])}
                                ${renderPlayerBadge(match.team2[1])}
                            </div>
                            <div class="team-info">
                                Groups: ${match.team2.map(p => p.group).join(', ')} | Total Rating: ${team2Rating.toFixed(2)}
                            </div>
                        </div>
                        
                        ${winner > 0 ? `
                            <div class="winner-banner">
                                üèÜ ${winner === 1 ? `${match.team1[0].name} & ${match.team1[1].name}` : `${match.team2[0].name} & ${match.team2[1].name}`} Win!
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateScore(matchIndex, team, value) {
            const score = parseInt(value);
            if (isNaN(score) || score < 0 || score > 16) {
                return;
            }
            
            if (team === 1) {
                matches[matchIndex].score1 = score;
            } else {
                matches[matchIndex].score2 = score;
            }
            
            saveToLocalStorage();
            renderMatches();
            renderStandings();
        }

        function clearScore(matchIndex) {
            matches[matchIndex].score1 = null;
            matches[matchIndex].score2 = null;
            saveToLocalStorage();
            renderMatches();
            renderStandings();
        }

        function renderPlayers() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = players.map(player => `
                <div class="player-edit-card">
                    <h3>#${player.id} ${player.tier}</h3>
                    <input type="text" id="player-name-${player.id}" value="${player.name}" 
                           placeholder="Player Name"
                           data-original="${player.name}"
                           oninput="checkForChanges()">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6B7280;">Skill Rating</label>
                    <input type="number" id="player-rating-${player.id}" step="0.05" min="0" max="5" value="${player.rating}"
                           data-original="${player.rating}"
                           oninput="checkForChanges()">
                </div>
            `).join('');
        }

        function checkForChanges() {
            let hasChanges = false;
            
            players.forEach(player => {
                const nameInput = document.getElementById(`player-name-${player.id}`);
                const ratingInput = document.getElementById(`player-rating-${player.id}`);
                
                if (nameInput && nameInput.value !== nameInput.dataset.original) {
                    hasChanges = true;
                    nameInput.classList.add('changed');
                } else if (nameInput) {
                    nameInput.classList.remove('changed');
                }
                
                if (ratingInput && ratingInput.value !== ratingInput.dataset.original) {
                    hasChanges = true;
                    ratingInput.classList.add('changed');
                } else if (ratingInput) {
                    ratingInput.classList.remove('changed');
                }
            });
            
            const indicator = document.getElementById('unsavedIndicator');
            if (indicator) {
                if (hasChanges) {
                    indicator.classList.add('show');
                } else {
                    indicator.classList.remove('show');
                }
            }
        }

        function savePlayerChanges(event) {
            let changesMade = false;
            
            players.forEach(player => {
                const nameInput = document.getElementById(`player-name-${player.id}`);
                const ratingInput = document.getElementById(`player-rating-${player.id}`);
                
                if (nameInput && nameInput.value !== player.name) {
                    player.name = nameInput.value;
                    nameInput.dataset.original = nameInput.value;
                    changesMade = true;
                }
                
                if (ratingInput && parseFloat(ratingInput.value) !== player.rating) {
                    player.rating = parseFloat(ratingInput.value);
                    ratingInput.dataset.original = ratingInput.value;
                    changesMade = true;
                }
            });
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Update all pages - MUST call renderMatches directly
            renderMatches();
            initializeFilters();
            renderStandings();
            
            // Hide unsaved indicator
            const indicator = document.getElementById('unsavedIndicator');
            if (indicator) {
                indicator.classList.remove('show');
            }
            
            // Remove changed styling
            document.querySelectorAll('.player-edit-card input').forEach(input => {
                input.classList.remove('changed');
            });
            
            // Show success feedback
            const btn = event ? event.target : document.querySelector('.btn-success');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Changes Saved!';
                btn.style.background = '#10B981';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }
        }

        function resetAllNames() {
            players.forEach((p, i) => {
                p.name = `Player ${i + 1}`;
            });
            saveToLocalStorage();
            renderPlayers();
            renderMatches();
            initializeFilters();
            
            const indicator = document.getElementById('unsavedIndicator');
            if (indicator) {
                indicator.classList.remove('show');
            }
        }

        function renderStandings() {
            const standings = calculateStandings();
            const table = document.getElementById('standingsTable');
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Pts</th>
                        <th>M</th>
                        <th>W</th>
                        <th>D</th>
                        <th>L</th>
                        <th>WR%</th>
                        <th>For</th>
                        <th>Agt</th>
                        <th>Diff</th>
                    </tr>
                </thead>
                <tbody>
                    ${standings.map((s, i) => `
                        <tr>
                            <td>
                                ${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}
                            </td>
                            <td>${renderPlayerBadge(s.player)}</td>
                            <td><strong>${s.points}</strong></td>
                            <td>${s.played}</td>
                            <td>${s.wins}</td>
                            <td>${s.draws}</td>
                            <td>${s.losses}</td>
                            <td>${s.winRate}%</td>
                            <td>${s.goalsFor}</td>
                            <td>${s.goalsAgainst}</td>
                            <td style="color: ${s.goalDiff >= 0 ? '#16A34A' : '#DC2626'}">
                                ${s.goalDiff >= 0 ? '+' : ''}${s.goalDiff}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function calculateStandings() {
            const standings = players.map(player => ({
                player: player,
                points: 0,
                played: 0,
                wins: 0,
                draws: 0,
                losses: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                goalDiff: 0,
                winRate: 0
            }));
            
            matches.forEach(match => {
                if (match.score1 === null || match.score2 === null) return;
                
                const team1Players = match.team1;
                const team2Players = match.team2;
                
                team1Players.forEach(p => {
                    const stat = standings.find(s => s.player.id === p.id);
                    stat.played++;
                    stat.goalsFor += match.score1;
                    stat.goalsAgainst += match.score2;
                    
                    if (match.score1 > match.score2) {
                        stat.wins++;
                        stat.points += 3;
                    } else if (match.score1 === match.score2) {
                        stat.draws++;
                        stat.points += 1;
                    } else {
                        stat.losses++;
                    }
                });
                
                team2Players.forEach(p => {
                    const stat = standings.find(s => s.player.id === p.id);
                    stat.played++;
                    stat.goalsFor += match.score2;
                    stat.goalsAgainst += match.score1;
                    
                    if (match.score2 > match.score1) {
                        stat.wins++;
                        stat.points += 3;
                    } else if (match.score1 === match.score2) {
                        stat.draws++;
                        stat.points += 1;
                    } else {
                        stat.losses++;
                    }
                });
            });
            
            standings.forEach(s => {
                s.goalDiff = s.goalsFor - s.goalsAgainst;
                s.winRate = s.played > 0 ? Math.round((s.wins / s.played) * 100) : 0;
            });
            
            standings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDiff !== a.goalDiff) return b.goalDiff - a.goalDiff;
                return b.goalsFor - a.goalsFor;
            });
            
            return standings;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'results') renderStandings();
            if (tabName === 'fairness1') renderFairness1();
            if (tabName === 'fairness2') renderFairness2();
            if (tabName === 'partnerships') renderPartnerships();
            if (tabName === 'knockout') renderKnockout();
        }

        function applyFilters() {
            const roundNav = document.getElementById('roundNavigation');
            const roundFilter = document.getElementById('roundFilter').value;
            const playerFilter = document.getElementById('playerFilter').value;
            
            if (roundFilter === 'all' && playerFilter === 'all') {
                roundNav.classList.remove('hidden');
            } else {
                roundNav.classList.add('hidden');
            }
            
            renderMatches();
        }

        function clearFilters() {
            document.getElementById('roundFilter').value = 'all';
            document.getElementById('playerFilter').value = 'all';
            applyFilters();
        }

        function initializeFilters() {
            const roundFilter = document.getElementById('roundFilter');
            const playerFilter = document.getElementById('playerFilter');
            
            roundFilter.innerHTML = '<option value="all">All Rounds</option>';
            for (let i = 1; i <= 13; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Round ${i}`;
                roundFilter.appendChild(option);
            }
            
            playerFilter.innerHTML = '<option value="all">All Players</option>';
            players.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                playerFilter.appendChild(option);
            });
        }

        function initializeRoundNavigation() {
            const nav = document.getElementById('roundNavigation');
            nav.innerHTML = Array.from({length: 13}, (_, i) => 
                `<button class="round-btn" onclick="filterByRound(${i + 1})">R${i + 1}</button>`
            ).join('');
        }

        function filterByRound(round) {
            document.getElementById('roundFilter').value = round;
            applyFilters();
        }

        function exportData() {
            const matchScores = matches.map(m => ({
                round: m.round,
                team1Ids: m.team1.map(p => p.id),
                team2Ids: m.team2.map(p => p.id),
                score1: m.score1,
                score2: m.score2,
                type: m.type
            }));
            
            const data = {
                players: players,
                matchScores: matchScores,
                knockoutMatches: knockoutMatches,
                knockoutConfig: knockoutConfig,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `padel-tournament-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    players = data.players;
                    
                    // Regenerate matches with current player references
                    generateMatches();
                    
                    // Apply saved scores
                    if (data.matchScores) {
                        data.matchScores.forEach((savedMatch, index) => {
                            if (matches[index]) {
                                matches[index].score1 = savedMatch.score1;
                                matches[index].score2 = savedMatch.score2;
                            }
                        });
                    } else if (data.matches) {
                        // Backward compatibility with old format
                        data.matches.forEach((savedMatch, index) => {
                            if (matches[index]) {
                                matches[index].score1 = savedMatch.score1;
                                matches[index].score2 = savedMatch.score2;
                            }
                        });
                    }
                    
                    knockoutMatches = data.knockoutMatches || { quarterFinals: [], semiFinals: [], final: null };
                    knockoutConfig = data.knockoutConfig || { qfPoints: 16, sfPoints: 16, finalPoints: 16 };
                    
                    saveToLocalStorage();
                    initializeFilters();
                    renderMatches();
                    renderPlayers();
                    alert('Tournament data imported successfully!');
                } catch (err) {
                    alert('Error importing file. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function resetScores() {
            if (confirm('Reset all match scores? This will create a backup first.')) {
                saveVersion(true);
                
                // Just clear scores, matches will keep player references
                matches.forEach(m => {
                    m.score1 = null;
                    m.score2 = null;
                });
                
                knockoutMatches = { quarterFinals: [], semiFinals: [], final: null };
                saveToLocalStorage();
                renderMatches();
                alert('All scores have been reset. A backup was created.');
            }
        }

        function saveVersion(auto = false) {
            const name = auto ? 'Auto-backup before reset' : prompt('Enter backup name:');
            if (!name && !auto) return;
            
            const versions = JSON.parse(localStorage.getItem('tournamentVersions') || '[]');
            
            const matchesRecorded = matches.filter(m => m.score1 !== null && m.score2 !== null).length;
            
            versions.push({
                name: name,
                timestamp: new Date().toISOString(),
                matchesRecorded: matchesRecorded,
                data: {
                    players: players,
                    matches: matches,
                    knockoutMatches: knockoutMatches,
                    knockoutConfig: knockoutConfig
                }
            });
            
            if (versions.length > 10) {
                versions.shift();
            }
            
            localStorage.setItem('tournamentVersions', JSON.stringify(versions));
            renderSavedVersions();
            if (!auto) alert('Backup saved successfully!');
        }

        function renderSavedVersions() {
            const container = document.getElementById('savedVersions');
            const versions = JSON.parse(localStorage.getItem('tournamentVersions') || '[]');
            
            if (versions.length === 0) {
                container.innerHTML = '<p style="color: #6B7280; text-align: center;">No saved versions yet</p>';
                return;
            }
            
            container.innerHTML = `
                <h3>Saved Versions (${versions.length}/10)</h3>
                ${versions.map((v, i) => `
                    <div class="version-item">
                        <div class="version-info">
                            <h4>${v.name}</h4>
                            <p>${new Date(v.timestamp).toLocaleString()}</p>
                            <p>${v.matchesRecorded} matches recorded</p>
                        </div>
                        <div class="version-actions">
                            <button class="btn btn-primary" onclick="loadVersion(${i})">Load</button>
                            <button class="btn btn-danger" onclick="deleteVersion(${i})">√ó</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function loadVersion(index) {
            if (confirm('Load this backup? Current data will be replaced.')) {
                const versions = JSON.parse(localStorage.getItem('tournamentVersions') || '[]');
                const version = versions[index];
                
                players = version.data.players;
                matches = version.data.matches;
                knockoutMatches = version.data.knockoutMatches || { quarterFinals: [], semiFinals: [], final: null };
                knockoutConfig = version.data.knockoutConfig || { qfPoints: 16, sfPoints: 16, finalPoints: 16 };
                
                saveToLocalStorage();
                initializeFilters();
                renderMatches();
                renderPlayers();
                alert('Backup loaded successfully!');
            }
        }

        function deleteVersion(index) {
            if (confirm('Delete this backup?')) {
                const versions = JSON.parse(localStorage.getItem('tournamentVersions') || '[]');
                versions.splice(index, 1);
                localStorage.setItem('tournamentVersions', JSON.stringify(versions));
                renderSavedVersions();
            }
        }

        function renderFairness1() {
            const table = document.getElementById('fairness1Table');
            const fairnessData = calculateFairness1();
            
            fairnessData.sort((a, b) => b.total - a.total);
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Rating</th>
                        <th>Total</th>
                        <th>Avg</th>
                        <th>Hardest</th>
                        <th>Easiest</th>
                        <th style="min-width: 400px;">All Rounds</th>
                    </tr>
                </thead>
                <tbody>
                    ${fairnessData.map(f => `
                        <tr>
                            <td>${renderPlayerBadge(f.player)}</td>
                            <td>${f.player.rating.toFixed(2)}</td>
                            <td style="font-weight: 600; color: ${f.total < 0 ? '#16A34A' : '#DC2626'}">
                                ${f.total.toFixed(2)}
                            </td>
                            <td>${f.avg.toFixed(2)}</td>
                            <td style="white-space: nowrap;">R${f.hardest.round}: ${f.hardest.value.toFixed(2)}</td>
                            <td style="white-space: nowrap;">R${f.easiest.round}: ${f.easiest.value.toFixed(2)}</td>
                            <td style="font-size: 11px;">
                                ${f.rounds.map((r, i) => `
                                    <span class="fairness-badge ${r < -0.3 ? 'fairness-negative' : r > 0.3 ? 'fairness-positive' : 'fairness-neutral'}" 
                                          title="Round ${i+1}: ${r.toFixed(2)}">
                                        ${r.toFixed(1)}
                                    </span>
                                `).join(' ')}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function calculateFairness1() {
            return players.map(player => {
                const rounds = [];
                
                for (let round = 1; round <= 13; round++) {
                    const playerMatches = matches.filter(m => 
                        m.round === round && (m.team1.some(p => p.id === player.id) || m.team2.some(p => p.id === player.id))
                    );
                    
                    if (playerMatches.length === 0) {
                        rounds.push(0);
                        continue;
                    }
                    
                    const match = playerMatches[0];
                    const isTeam1 = match.team1.some(p => p.id === player.id);
                    const myTeam = isTeam1 ? match.team1 : match.team2;
                    const opponentTeam = isTeam1 ? match.team2 : match.team1;
                    
                    const myTeamRating = myTeam.reduce((sum, p) => sum + p.rating, 0);
                    const opponentTeamRating = opponentTeam.reduce((sum, p) => sum + p.rating, 0);
                    
                    const fairness = myTeamRating - opponentTeamRating;
                    rounds.push(fairness);
                }
                
                const total = rounds.reduce((sum, r) => sum + r, 0);
                const avg = total / rounds.length;
                const hardest = { round: rounds.indexOf(Math.min(...rounds)) + 1, value: Math.min(...rounds) };
                const easiest = { round: rounds.indexOf(Math.max(...rounds)) + 1, value: Math.max(...rounds) };
                
                return { player, total, avg, hardest, easiest, rounds };
            });
        }

        function renderFairness2() {
            const table = document.getElementById('fairness2Table');
            const fairnessData = calculateFairness2();
            
            fairnessData.sort((a, b) => b.total - a.total);
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Rating</th>
                        <th>Total</th>
                        <th>Avg</th>
                        <th>Best Partner</th>
                        <th>Worst Partner</th>
                        <th style="min-width: 400px;">All Rounds</th>
                    </tr>
                </thead>
                <tbody>
                    ${fairnessData.map(f => `
                        <tr>
                            <td>${renderPlayerBadge(f.player)}</td>
                            <td>${f.player.rating.toFixed(2)}</td>
                            <td style="font-weight: 600; color: ${f.total > 0 ? '#16A34A' : '#DC2626'}">
                                ${f.total.toFixed(2)}
                            </td>
                            <td>${f.avg.toFixed(2)}</td>
                            <td style="white-space: nowrap;">R${f.best.round}: ${f.best.value.toFixed(2)}</td>
                            <td style="white-space: nowrap;">R${f.worst.round}: ${f.worst.value.toFixed(2)}</td>
                            <td style="font-size: 11px;">
                                ${f.rounds.map((r, i) => `
                                    <span class="fairness-badge ${r > 0.3 ? 'fairness-positive' : r < -0.3 ? 'fairness-negative' : 'fairness-neutral'}"
                                          title="Round ${i+1}: ${r.toFixed(2)}">
                                        ${r.toFixed(1)}
                                    </span>
                                `).join(' ')}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function calculateFairness2() {
            return players.map(player => {
                const rounds = [];
                
                for (let round = 1; round <= 13; round++) {
                    const playerMatches = matches.filter(m => 
                        m.round === round && (m.team1.some(p => p.id === player.id) || m.team2.some(p => p.id === player.id))
                    );
                    
                    if (playerMatches.length === 0) {
                        rounds.push(0);
                        continue;
                    }
                    
                    const match = playerMatches[0];
                    const isTeam1 = match.team1.some(p => p.id === player.id);
                    const myTeam = isTeam1 ? match.team1 : match.team2;
                    const opponentTeam = isTeam1 ? match.team2 : match.team1;
                    
                    const partner = myTeam.find(p => p.id !== player.id);
                    
                    const avgOpponentRating = opponentTeam.reduce((sum, p) => sum + p.rating, 0) / 2;
                    
                    const fairness = partner.rating - avgOpponentRating;
                    rounds.push(fairness);
                }
                
                const total = rounds.reduce((sum, r) => sum + r, 0);
                const avg = total / rounds.length;
                const best = { round: rounds.indexOf(Math.max(...rounds)) + 1, value: Math.max(...rounds) };
                const worst = { round: rounds.indexOf(Math.min(...rounds)) + 1, value: Math.min(...rounds) };
                
                return { player, total, avg, best, worst, rounds };
            });
        }

        function renderPartnerships() {
            const stats = calculatePartnershipStats();
            const statsContainer = document.getElementById('partnershipStats');
            const partnershipMatrix = document.getElementById('partnershipMatrix');
            const opponentMatrix = document.getElementById('opponentMatrix');
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalPartnerships}</div>
                    <div class="stat-label">Total Partnerships</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.uniquePartnerships}</div>
                    <div class="stat-label">Unique Partnerships<br>(${stats.partnershipCoverage}% coverage)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalOpponents}</div>
                    <div class="stat-label">Total Opponent Matchups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.uniqueOpponents}</div>
                    <div class="stat-label">Unique Opponent Pairs<br>(${stats.opponentCoverage}% coverage)</div>
                </div>
            `;
            
            partnershipMatrix.innerHTML = renderPartnershipMatrix(stats.partnershipMatrix);
            opponentMatrix.innerHTML = renderOpponentMatrix(stats.opponentMatrix);
        }

        function calculatePartnershipStats() {
            const partnershipMatrix = Array(24).fill(0).map(() => Array(24).fill(0));
            const opponentMatrix = Array(24).fill(0).map(() => Array(24).fill(0));
            
            matches.forEach(match => {
                const team1p1 = match.team1[0].id - 1;
                const team1p2 = match.team1[1].id - 1;
                const team2p1 = match.team2[0].id - 1;
                const team2p2 = match.team2[1].id - 1;
                
                partnershipMatrix[team1p1][team1p2]++;
                partnershipMatrix[team1p2][team1p1]++;
                
                partnershipMatrix[team2p1][team2p2]++;
                partnershipMatrix[team2p2][team2p1]++;
                
                match.team1.forEach(p1 => {
                    match.team2.forEach(p2 => {
                        opponentMatrix[p1.id - 1][p2.id - 1]++;
                        opponentMatrix[p2.id - 1][p1.id - 1]++;
                    });
                });
            });
            
            let totalPartnerships = 0;
            let uniquePartnerships = 0;
            let totalOpponents = 0;
            let uniqueOpponents = 0;
            
            for (let i = 0; i < 24; i++) {
                for (let j = i + 1; j < 24; j++) {
                    if (partnershipMatrix[i][j] > 0) {
                        totalPartnerships += partnershipMatrix[i][j];
                        uniquePartnerships++;
                    }
                    if (opponentMatrix[i][j] > 0) {
                        totalOpponents += opponentMatrix[i][j];
                        uniqueOpponents++;
                    }
                }
            }
            
            const maxPartnerships = (24 * 23) / 2;
            const maxOpponents = (24 * 23) / 2;
            
            return {
                partnershipMatrix,
                opponentMatrix,
                totalPartnerships,
                uniquePartnerships,
                partnershipCoverage: ((uniquePartnerships / maxPartnerships) * 100).toFixed(1),
                totalOpponents,
                uniqueOpponents,
                opponentCoverage: ((uniqueOpponents / maxOpponents) * 100).toFixed(1)
            };
        }

        function renderPartnershipMatrix(matrix) {
            let html = '<div style="overflow-x: auto;"><table class="matrix-table"><thead><tr><th></th>';
            for (let i = 1; i <= 24; i++) {
                html += `<th>${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < 24; i++) {
                html += `<tr><th>${i + 1}</th>`;
                for (let j = 0; j < 24; j++) {
                    if (i === j) {
                        html += '<td style="background: #E5E7EB;">-</td>';
                    } else {
                        const value = matrix[i][j];
                        const cellClass = value === 0 ? 'matrix-cell-0' : 
                                         value === 1 ? 'matrix-cell-1' : 
                                         value === 2 ? 'matrix-cell-2' : 'matrix-cell-3';
                        html += `<td class="${cellClass}" title="Player ${i+1} & Player ${j+1}: ${value} times">${value || ''}</td>`;
                    }
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            
            html += `
                <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; font-size: 13px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #F9FAFB; border: 1px solid #E5E7EB;"></div>
                        <span>0 partnerships</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #DBEAFE; border: 1px solid #E5E7EB;"></div>
                        <span>1 partnership</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #BFDBFE; border: 1px solid #E5E7EB;"></div>
                        <span>2 partnerships</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #93C5FD; border: 1px solid #E5E7EB;"></div>
                        <span>3+ partnerships</span>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderOpponentMatrix(matrix) {
            let html = '<div style="overflow-x: auto;"><table class="matrix-table"><thead><tr><th></th>';
            for (let i = 1; i <= 24; i++) {
                html += `<th>${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < 24; i++) {
                html += `<tr><th>${i + 1}</th>`;
                for (let j = 0; j < 24; j++) {
                    if (i === j) {
                        html += '<td style="background: #E5E7EB;">-</td>';
                    } else {
                        const value = matrix[i][j];
                        let bgColor = '#F9FAFB';
                        if (value > 0 && value <= 2) {
                            bgColor = '#D1FAE5';
                        } else if (value > 2 && value <= 4) {
                            bgColor = '#A7F3D0';
                        } else if (value > 4) {
                            bgColor = '#6EE7B7';
                        }
                        html += `<td style="background: ${bgColor};" title="Player ${i+1} vs Player ${j+1}: ${value} times">${value || ''}</td>`;
                    }
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            
            html += `
                <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; font-size: 13px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #F9FAFB; border: 1px solid #E5E7EB;"></div>
                        <span>0 matchups</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #D1FAE5; border: 1px solid #E5E7EB;"></div>
                        <span>1-2 matchups</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #A7F3D0; border: 1px solid #E5E7EB;"></div>
                        <span>3-4 matchups</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 20px; background: #6EE7B7; border: 1px solid #E5E7EB;"></div>
                        <span>5+ matchups</span>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderKnockout() {
            const standings = calculateStandings();
            const top12 = standings.slice(0, 12);
            
            const qualifiedContainer = document.getElementById('qualifiedPlayers');
            qualifiedContainer.innerHTML = top12.map((s, i) => `
                <div class="qualified-badge ${getTierClass(s.player)}">
                    #${i + 1} ${s.player.name}
                </div>
            `).join('');
            
            if (knockoutMatches.quarterFinals.length === 0) {
                initializeKnockout(top12);
            }
            
            renderQuarterFinals();
            renderSemiFinals();
            renderFinal();
            loadKnockoutConfig();
        }

        function initializeKnockout(top12) {
            knockoutMatches.quarterFinals = [
                { team1: [top12[0].player, top12[2].player], team2: [top12[13-1] ? top12[13-1].player : null, top12[15-1] ? top12[15-1].player : null], score1: null, score2: null },
                { team1: [top12[1].player, top12[3].player], team2: [top12[12-1] ? top12[12-1].player : null, top12[14-1] ? top12[14-1].player : null], score1: null, score2: null },
                { team1: [top12[4].player, top12[6].player], team2: [top12[9].player, top12[11].player], score1: null, score2: null },
                { team1: [top12[5].player, top12[7].player], team2: [top12[8].player, top12[10].player], score1: null, score2: null }
            ];
            
            knockoutMatches.semiFinals = [
                { team1: null, team2: null, score1: null, score2: null },
                { team1: null, team2: null, score1: null, score2: null }
            ];
            
            knockoutMatches.final = { team1: null, team2: null, score1: null, score2: null };
        }

        function renderQuarterFinals() {
            const container = document.getElementById('quarterFinals');
            const maxPoints = knockoutConfig.qfPoints;
            
            container.innerHTML = knockoutMatches.quarterFinals.map((match, i) => {
                const isComplete = match.score1 !== null && match.score2 !== null;
                const winner = isComplete ? (match.score1 > match.score2 ? 1 : 2) : 0;
                
                return `
                    <div class="bracket-match">
                        <h3>QF${i + 1}</h3>
                        <h4>${['1st/3rd vs 14th/16th', '2nd/4th vs 13th/15th', '5th/7th vs 10th/12th', '6th/8th vs 9th/11th'][i]}</h4>
                        
                        <div class="team-section">
                            <div class="team-players">
                                ${renderPlayerBadge(match.team1[0])}
                                ${renderPlayerBadge(match.team1[1])}
                            </div>
                        </div>
                        
                        <div class="score-input">
                            <input type="number" min="0" max="${maxPoints}" value="${match.score1 !== null ? match.score1 : ''}" 
                                   onchange="updateKnockoutScore('quarterFinals', ${i}, 1, this.value)"
                                   placeholder="__">
                            <span class="score-divider">-</span>
                            <input type="number" min="0" max="${maxPoints}" value="${match.score2 !== null ? match.score2 : ''}"
                                   onchange="updateKnockoutScore('quarterFinals', ${i}, 2, this.value)"
                                   placeholder="__">
                            ${isComplete ? `<button class="clear-score-btn" onclick="clearKnockoutScore('quarterFinals', ${i})">Clear √ó</button>` : ''}
                        </div>
                        
                        <div class="team-section">
                            <div class="team-players">
                                ${match.team2[0] ? renderPlayerBadge(match.team2[0]) : '<div class="player-badge tier-beginner">TBD</div>'}
                                ${match.team2[1] ? renderPlayerBadge(match.team2[1]) : '<div class="player-badge tier-beginner">TBD</div>'}
                            </div>
                        </div>
                        
                        ${winner > 0 ? `
                            <div class="winner-banner">
                                üèÜ Winners advance to Semi Finals
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderSemiFinals() {
            const container = document.getElementById('semiFinals');
            const maxPoints = knockoutConfig.sfPoints;
            
            updateSemiFinals();
            
            container.innerHTML = knockoutMatches.semiFinals.map((match, i) => {
                if (!match.team1 || !match.team2) {
                    return `
                        <div class="bracket-match">
                            <h3>SF${i + 1}</h3>
                            <h4>${i === 0 ? 'Winner QF1 vs Winner QF4' : 'Winner QF2 vs Winner QF3'}</h4>
                            <p style="text-align: center; color: #6B7280; padding: 20px;">
                                Complete Quarter Finals to unlock
                            </p>
                        </div>
                    `;
                }
                
                const isComplete = match.score1 !== null && match.score2 !== null;
                const winner = isComplete ? (match.score1 > match.score2 ? 1 : 2) : 0;
                
                return `
                    <div class="bracket-match">
                        <h3>SF${i + 1}</h3>
                        <h4>${i === 0 ? 'Winner QF1 vs Winner QF4' : 'Winner QF2 vs Winner QF3'}</h4>
                        
                        <div class="team-section">
                            <div class="team-players">
                                ${renderPlayerBadge(match.team1[0])}
                                ${renderPlayerBadge(match.team1[1])}
                            </div>
                        </div>
                        
                        <div class="score-input">
                            <input type="number" min="0" max="${maxPoints}" value="${match.score1 !== null ? match.score1 : ''}" 
                                   onchange="updateKnockoutScore('semiFinals', ${i}, 1, this.value)"
                                   placeholder="__">
                            <span class="score-divider">-</span>
                            <input type="number" min="0" max="${maxPoints}" value="${match.score2 !== null ? match.score2 : ''}"
                                   onchange="updateKnockoutScore('semiFinals', ${i}, 2, this.value)"
                                   placeholder="__">
                            ${isComplete ? `<button class="clear-score-btn" onclick="clearKnockoutScore('semiFinals', ${i})">Clear √ó</button>` : ''}
                        </div>
                        
                        <div class="team-section">
                            <div class="team-players">
                                ${renderPlayerBadge(match.team2[0])}
                                ${renderPlayerBadge(match.team2[1])}
                            </div>
                        </div>
                        
                        ${winner > 0 ? `
                            <div class="winner-banner">
                                üèÜ Winners advance to Final
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderFinal() {
            const container = document.getElementById('final');
            const maxPoints = knockoutConfig.finalPoints;
            
            updateFinal();
            
            const match = knockoutMatches.final;
            
            if (!match.team1 || !match.team2) {
                container.innerHTML = `
                    <div class="bracket-match final-match">
                        <h3>üèÜ CHAMPIONSHIP FINAL üèÜ</h3>
                        <h4>Winner SF1 vs Winner SF2</h4>
                        <p style="text-align: center; color: #6B7280; padding: 20px;">
                            Complete Semi Finals to unlock
                        </p>
                    </div>
                `;
                return;
            }
            
            const isComplete = match.score1 !== null && match.score2 !== null;
            const winner = isComplete ? (match.score1 > match.score2 ? 1 : 2) : 0;
            
            container.innerHTML = `
                <div class="bracket-match final-match">
                    <h3>üèÜ CHAMPIONSHIP FINAL üèÜ</h3>
                    <h4>Winner SF1 vs Winner SF2</h4>
                    
                    <div class="team-section">
                        <div class="team-players">
                            ${renderPlayerBadge(match.team1[0])}
                            ${renderPlayerBadge(match.team1[1])}
                        </div>
                    </div>
                    
                    <div class="score-input">
                        <input type="number" min="0" max="${maxPoints}" value="${match.score1 !== null ? match.score1 : ''}" 
                               onchange="updateKnockoutScore('final', 0, 1, this.value)"
                               placeholder="__">
                        <span class="score-divider">-</span>
                        <input type="number" min="0" max="${maxPoints}" value="${match.score2 !== null ? match.score2 : ''}"
                               onchange="updateKnockoutScore('final', 0, 2, this.value)"
                               placeholder="__">
                        ${isComplete ? `<button class="clear-score-btn" onclick="clearKnockoutScore('final', 0)">Clear √ó</button>` : ''}
                    </div>
                    
                    <div class="team-section">
                        <div class="team-players">
                            ${renderPlayerBadge(match.team2[0])}
                            ${renderPlayerBadge(match.team2[1])}
                        </div>
                    </div>
                    
                    ${winner > 0 ? `
                        <div class="champion-banner">
                            üéâ TOURNAMENT CHAMPIONS! üéâ<br>
                            ${winner === 1 ? `${match.team1[0].name} & ${match.team1[1].name}` : `${match.team2[0].name} & ${match.team2[1].name}`}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateKnockoutScore(stage, matchIndex, team, value) {
            const score = parseInt(value);
            const maxPoints = stage === 'quarterFinals' ? knockoutConfig.qfPoints : 
                            stage === 'semiFinals' ? knockoutConfig.sfPoints : knockoutConfig.finalPoints;
            
            if (isNaN(score) || score < 0 || score > maxPoints) return;
            
            const match = stage === 'final' ? knockoutMatches.final : knockoutMatches[stage][matchIndex];
            
            if (team === 1) {
                match.score1 = score;
            } else {
                match.score2 = score;
            }
            
            saveToLocalStorage();
            renderKnockout();
        }

        function clearKnockoutScore(stage, matchIndex) {
            const match = stage === 'final' ? knockoutMatches.final : knockoutMatches[stage][matchIndex];
            match.score1 = null;
            match.score2 = null;
            
            if (stage === 'quarterFinals') {
                knockoutMatches.semiFinals.forEach(m => {
                    m.team1 = null;
                    m.team2 = null;
                    m.score1 = null;
                    m.score2 = null;
                });
                knockoutMatches.final.team1 = null;
                knockoutMatches.final.team2 = null;
                knockoutMatches.final.score1 = null;
                knockoutMatches.final.score2 = null;
            } else if (stage === 'semiFinals') {
                knockoutMatches.final.team1 = null;
                knockoutMatches.final.team2 = null;
                knockoutMatches.final.score1 = null;
                knockoutMatches.final.score2 = null;
            }
            
            saveToLocalStorage();
            renderKnockout();
        }

        function updateSemiFinals() {
            const qf = knockoutMatches.quarterFinals;
            
            if (qf[0].score1 !== null && qf[0].score2 !== null && qf[3].score1 !== null && qf[3].score2 !== null) {
                knockoutMatches.semiFinals[0].team1 = qf[0].score1 > qf[0].score2 ? qf[0].team1 : qf[0].team2;
                knockoutMatches.semiFinals[0].team2 = qf[3].score1 > qf[3].score2 ? qf[3].team1 : qf[3].team2;
            }
            
            if (qf[1].score1 !== null && qf[1].score2 !== null && qf[2].score1 !== null && qf[2].score2 !== null) {
                knockoutMatches.semiFinals[1].team1 = qf[1].score1 > qf[1].score2 ? qf[1].team1 : qf[1].team2;
                knockoutMatches.semiFinals[1].team2 = qf[2].score1 > qf[2].score2 ? qf[2].team1 : qf[2].team2;
            }
        }

        function updateFinal() {
            const sf = knockoutMatches.semiFinals;
            
            if (sf[0].score1 !== null && sf[0].score2 !== null && sf[1].score1 !== null && sf[1].score2 !== null) {
                knockoutMatches.final.team1 = sf[0].score1 > sf[0].score2 ? sf[0].team1 : sf[0].team2;
                knockoutMatches.final.team2 = sf[1].score1 > sf[1].score2 ? sf[1].team1 : sf[1].team2;
            }
        }

        function saveKnockoutConfig() {
            knockoutConfig.qfPoints = parseInt(document.getElementById('qfPoints').value);
            knockoutConfig.sfPoints = parseInt(document.getElementById('sfPoints').value);
            knockoutConfig.finalPoints = parseInt(document.getElementById('finalPoints').value);
            saveToLocalStorage();
        }

        function loadKnockoutConfig() {
            document.getElementById('qfPoints').value = knockoutConfig.qfPoints;
            document.getElementById('sfPoints').value = knockoutConfig.sfPoints;
            document.getElementById('finalPoints').value = knockoutConfig.finalPoints;
        }

        function saveToLocalStorage() {
            // Only save scores, not the entire matches with player objects
            const matchScores = matches.map(m => ({
                round: m.round,
                team1Ids: m.team1.map(p => p.id),
                team2Ids: m.team2.map(p => p.id),
                score1: m.score1,
                score2: m.score2,
                type: m.type
            }));
            
            const data = {
                players: players,
                matchScores: matchScores,
                knockoutMatches: knockoutMatches,
                knockoutConfig: knockoutConfig
            };
            localStorage.setItem('tournamentData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('tournamentData');
            if (saved) {
                const data = JSON.parse(saved);
                players = data.players;
                
                // Regenerate matches with current player references
                generateMatches();
                
                // Apply saved scores to the regenerated matches
                if (data.matchScores) {
                    data.matchScores.forEach((savedMatch, index) => {
                        if (matches[index]) {
                            matches[index].score1 = savedMatch.score1;
                            matches[index].score2 = savedMatch.score2;
                        }
                    });
                }
                
                knockoutMatches = data.knockoutMatches || { quarterFinals: [], semiFinals: [], final: null };
                knockoutConfig = data.knockoutConfig || { qfPoints: 16, sfPoints: 16, finalPoints: 16 };
            }
        }

        function init() {
            initializePlayers();
            generateMatches();
            loadFromLocalStorage();
            initializeFilters();
            initializeRoundNavigation();
            renderMatches();
            renderPlayers();
            renderSavedVersions();
        }

        init();
    </script>
</body>
</html>
